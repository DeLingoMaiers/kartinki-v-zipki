name: Images to ZIP

on:
  workflow_dispatch:
    inputs:
      gist_id:
        description: 'Gist ID'
        required: true
      folder_name:
        description: 'Output folder name'
        required: false
        default: 'export'

jobs:
  create-zip:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Download images and create ZIP
        env:
          GIST_ID: ${{ github.event.inputs.gist_id }}
          FOLDER_NAME: ${{ github.event.inputs.folder_name }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          pip install requests

          python3 << 'EOF'
          import os
          import json
          import requests
          import zipfile
          import concurrent.futures

          GIST_ID = os.environ['GIST_ID']
          GH_TOKEN = os.environ['GH_TOKEN']
          FOLDER_NAME = os.environ.get('FOLDER_NAME', 'export')
          
          headers = {'Authorization': f'token {GH_TOKEN}'}

          print(f"Fetching Gist: {GIST_ID}")
          gist_resp = requests.get(f'https://api.github.com/gists/{GIST_ID}', headers=headers)
          gist_resp.raise_for_status()
          gist_data = gist_resp.json()
          
          images_content = gist_data['files']['images.json']['content']
          images = json.loads(images_content)
          
          print(f"Processing {len(images)} images...")

          def download_image(item):
              url = item.get('url')
              name = item.get('name', 'image')
              img_type = item.get('type', 'main')
              
              if not url:
                  return None
              
              try:
                  r = requests.get(url, timeout=60, allow_redirects=True)
                  if r.status_code == 200:
                      content_type = r.headers.get('content-type', '')
                      ext = '.png'
                      if 'jpeg' in content_type or 'jpg' in content_type:
                          ext = '.jpg'
                      elif 'webp' in content_type:
                          ext = '.webp'
                      elif 'svg' in content_type:
                          ext = '.svg'
                      
                      filename = f"{name}_{img_type}{ext}"
                      filename = "".join(c for c in filename if c.isalnum() or c in '._- ').strip()
                      return (filename, r.content)
              except Exception as e:
                  print(f"Error downloading {name}: {e}")
              return None

          print("Downloading images...")
          with concurrent.futures.ThreadPoolExecutor(max_workers=30) as executor:
              results = list(executor.map(download_image, images))
              downloaded = [r for r in results if r is not None]

          print(f"Downloaded {len(downloaded)} of {len(images)} images")

          if len(downloaded) == 0:
              result = {'success': False, 'error': 'No images downloaded', 'status': 'failed'}
              
              requests.patch(
                  f'https://api.github.com/gists/{GIST_ID}',
                  headers=headers,
                  json={'files': {'result.json': {'content': json.dumps(result)}}}
              )
              exit(1)

          zip_path = f'/tmp/{FOLDER_NAME}.zip'
          print("Creating ZIP...")
          with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zf:
              for filename, content in downloaded:
                  zf.writestr(filename, content)

          zip_size = os.path.getsize(zip_path)
          print(f"ZIP created: {zip_size / 1024 / 1024:.2f} MB")

          # Сохраняем путь для следующего шага
          with open('/tmp/zip_info.json', 'w') as f:
              json.dump({
                  'zip_path': zip_path,
                  'zip_size': zip_size,
                  'files_count': len(downloaded),
                  'total_files': len(images),
                  'folder_name': FOLDER_NAME
              }, f)
          EOF

      - name: Create Release and upload ZIP
        env:
          GIST_ID: ${{ github.event.inputs.gist_id }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
          REPO: ${{ github.repository }}
        run: |
          python3 << 'EOF'
          import os
          import json
          import requests
          from datetime import datetime

          GIST_ID = os.environ['GIST_ID']
          GH_TOKEN = os.environ['GH_TOKEN']
          REPO = os.environ['REPO']
          
          headers = {
              'Authorization': f'token {GH_TOKEN}',
              'Accept': 'application/vnd.github.v3+json'
          }

          with open('/tmp/zip_info.json') as f:
              info = json.load(f)

          zip_path = info['zip_path']
          folder_name = info['folder_name']
          tag_name = f"export-{datetime.now().strftime('%Y%m%d-%H%M%S')}"

          print(f"Creating release: {tag_name}")
          
          # Создаём release
          release_resp = requests.post(
              f'https://api.github.com/repos/{REPO}/releases',
              headers=headers,
              json={
                  'tag_name': tag_name,
                  'name': f'Export {folder_name}',
                  'body': f'Auto-generated export with {info["files_count"]} images',
                  'draft': False,
                  'prerelease': False
              }
          )
          
          if release_resp.status_code != 201:
              print(f"Failed to create release: {release_resp.status_code} - {release_resp.text}")
              exit(1)
          
          release = release_resp.json()
          upload_url = release['upload_url'].replace('{?name,label}', '')
          
          print(f"Uploading ZIP to release...")
          
          # Загружаем ZIP
          with open(zip_path, 'rb') as f:
              upload_resp = requests.post(
                  f'{upload_url}?name={folder_name}.zip',
                  headers={
                      'Authorization': f'token {GH_TOKEN}',
                      'Content-Type': 'application/zip'
                  },
                  data=f
              )
          
          if upload_resp.status_code != 201:
              print(f"Failed to upload: {upload_resp.status_code} - {upload_resp.text}")
              exit(1)
          
          asset = upload_resp.json()
          download_url = asset['browser_download_url']
          
          print(f"Uploaded! URL: {download_url}")

          # Сохраняем результат в Gist
          result = {
              'success': True,
              'status': 'completed',
              'downloadUrl': download_url,
              'fileName': f'{folder_name}.zip',
              'filesCount': info['files_count'],
              'totalFiles': info['total_files'],
              'fileSize': info['zip_size'],
              'fileSizeMB': round(info['zip_size'] / 1024 / 1024, 2),
              'releaseTag': tag_name
          }

          requests.patch(
              f'https://api.github.com/gists/{GIST_ID}',
              headers={'Authorization': f'token {GH_TOKEN}'},
              json={'files': {'result.json': {'content': json.dumps(result, indent=2)}}}
          )
          
          print("Done!")
          print(json.dumps(result, indent=2))
          EOF
