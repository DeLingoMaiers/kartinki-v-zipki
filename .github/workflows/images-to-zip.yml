name: Images to ZIP

on:
  workflow_dispatch:
    inputs:
      gist_url:
        description: 'URL to JSON file with image list'
        required: true
      folder_name:
        description: 'Output folder name'
        required: false
        default: 'export'
      callback_url:
        description: 'Webhook URL for result'
        required: false

jobs:
  create-zip:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Download images and create ZIP
        env:
          GIST_URL: ${{ github.event.inputs.gist_url }}
          FOLDER_NAME: ${{ github.event.inputs.folder_name }}
          CALLBACK_URL: ${{ github.event.inputs.callback_url }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pip install requests google-auth google-api-python-client

          python3 << 'EOF'
          import os
          import json
          import requests
          import zipfile
          import concurrent.futures
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload

          # Скачиваем JSON из Gist
          GIST_URL = os.environ['GIST_URL']
          GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN', '')
          
          headers = {}
          if GITHUB_TOKEN:
              headers['Authorization'] = f'token {GITHUB_TOKEN}'
          
          print(f"Fetching images list from: {GIST_URL}")
          resp = requests.get(GIST_URL, headers=headers, timeout=30)
          resp.raise_for_status()
          images = json.loads(resp.text)
          
          FOLDER_NAME = os.environ.get('FOLDER_NAME', 'export')
          CALLBACK_URL = os.environ.get('CALLBACK_URL', '')

          print(f"Processing {len(images)} images...")

          def download_image(item):
              url = item.get('url')
              name = item.get('name', 'image')
              img_type = item.get('type', 'main')
              
              if not url:
                  return None
              
              try:
                  r = requests.get(url, timeout=60, allow_redirects=True)
                  if r.status_code == 200:
                      content_type = r.headers.get('content-type', '')
                      ext = '.png'
                      if 'jpeg' in content_type or 'jpg' in content_type:
                          ext = '.jpg'
                      elif 'webp' in content_type:
                          ext = '.webp'
                      elif 'svg' in content_type:
                          ext = '.svg'
                      
                      filename = f"{name}_{img_type}{ext}"
                      filename = "".join(c for c in filename if c.isalnum() or c in '._- ').strip()
                      return (filename, r.content)
              except Exception as e:
                  print(f"Error downloading {name}: {e}")
              return None

          print("Downloading images...")
          downloaded = []
          with concurrent.futures.ThreadPoolExecutor(max_workers=30) as executor:
              results = list(executor.map(download_image, images))
              downloaded = [r for r in results if r is not None]

          print(f"Downloaded {len(downloaded)} of {len(images)} images")

          if len(downloaded) == 0:
              print("ERROR: No images downloaded!")
              result = {'success': False, 'error': 'No images downloaded'}
              if CALLBACK_URL:
                  requests.post(CALLBACK_URL, json=result, timeout=30)
              exit(1)

          zip_path = f'/tmp/{FOLDER_NAME}.zip'
          print("Creating ZIP...")
          with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zf:
              for filename, content in downloaded:
                  zf.writestr(filename, content)

          zip_size = os.path.getsize(zip_path)
          print(f"ZIP created: {zip_size / 1024 / 1024:.2f} MB")

          result = {'success': False, 'error': 'No Google credentials'}
          
          creds_json = os.environ.get('GOOGLE_CREDENTIALS')
          if creds_json:
              print("Uploading to Google Drive...")
              try:
                  creds_dict = json.loads(creds_json)
                  creds = service_account.Credentials.from_service_account_info(
                      creds_dict,
                      scopes=['https://www.googleapis.com/auth/drive.file']
                  )
                  drive = build('drive', 'v3', credentials=creds)
                  
                  file_metadata = {'name': f'{FOLDER_NAME}.zip'}
                  media = MediaFileUpload(zip_path, mimetype='application/zip', resumable=True)
                  file = drive.files().create(
                      body=file_metadata, 
                      media_body=media, 
                      fields='id,webViewLink'
                  ).execute()
                  
                  drive.permissions().create(
                      fileId=file['id'],
                      body={'type': 'anyone', 'role': 'reader'}
                  ).execute()
                  
                  download_url = f"https://drive.google.com/uc?export=download&id={file['id']}"
                  
                  result = {
                      'success': True,
                      'downloadUrl': download_url,
                      'viewUrl': file['webViewLink'],
                      'filesCount': len(downloaded),
                      'totalFiles': len(images),
                      'fileSize': zip_size,
                      'fileSizeMB': round(zip_size / 1024 / 1024, 2)
                  }
                  
                  print(f"Uploaded! Download: {download_url}")
                  
              except Exception as e:
                  print(f"Google Drive error: {e}")
                  result = {'success': False, 'error': str(e)}

          if CALLBACK_URL:
              try:
                  requests.post(CALLBACK_URL, json=result, timeout=30)
                  print("Callback sent")
              except Exception as e:
                  print(f"Callback error: {e}")

          print("\n=== RESULT ===")
          print(json.dumps(result, indent=2))
          EOF

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: images-zip
          path: /tmp/*.zip
          retention-days: 1
          if-no-files-found: ignore
